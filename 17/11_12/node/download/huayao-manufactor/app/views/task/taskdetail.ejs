<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="wap-font-scale" content="no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" >
    <title>任务详情页</title>
    <link rel="stylesheet" href="../commoncss/amazeui.min.css">
    <link rel="stylesheet" href="../views/css/taskdetail.css">
    <link rel="stylesheet" type="text/css" href="../views/css/dist/starability-all.min.css"/>
</head>
<body>
<header>
    <a href="#" class="goback" onclick="javascript:history.back(-1)"></a>
    <p class="order-num">订单编号：
        <% if(orderInfo.data){%>
        <span><%= orderInfo.data.orderNo%></span>
        <% } %>
    </p>
</header>
<div class="taskdetail">
    <div data-am-widget="tabs" class="am-tabs am-tabs-default">
        <ul class="am-tabs-nav am-cf">
            <li class="am-active"><a href="[data-tab-panel-0]">订单详情</a></li>
            <li class=""><a href="[data-tab-panel-1]">承运车辆</a></li>
            <li class=""><a href="[data-tab-panel-2]">订单追踪</a></li>
        </ul>
        <div class="am-tabs-bd">
            <div data-tab-panel-0 class="am-tab-panel am-active orderde">
                <% if(orderInfo.data){%>
                <div class="box">
                    <div class="code">
                        <img src="../views/images/task/code.png" alt="">
                        <p>订单编号：
                            <%= orderInfo.data.orderNo%>
                        </p>
                    </div>
                    <div class="list">
                        <ul>
                            <li>序号</li>
                            <li>编号</li>
                            <li>药品名称</li>
                            <li>数量</li>
                        </ul>
                        <% orderInfo.data.itemList.forEach(function(item,i){ %>
                        <ul>

                                <li>
                                    <%= i+1 %>
                                </li>
                                <li>
                                    <%= item.productCode %>
                                </li>
                                <li>
                                    <a href="/drug/drugdetails?product=<%= item.productSid %>'">
                                        <%= item.productName%>
                                    </a>
                                </li>
                                <li>
                                    <%= item.orderNum%>
                                </li>
                        </ul>
                        <% }) %>
                    </div>
                    <div class="detail">
                        <div>
                            <p>总体积：</p>
                            <p><span><%= orderInfo.data.totalVolume%></span></p>
                            <p>m<sup>3</sup></p>
                        </div>
                        <div>
                            <p>总重：</p>
                            <p><span><%= orderInfo.data.totalWeight%></span></p>
                            <p>kg</p>
                        </div>
                        <div>
                            <p>总价：</p>
                            <p><span><%= orderInfo.data.totalAmount%></span></p>
                            <p>元</p>
                        </div>
                    </div>
                    <div class="address">
                        <div class="orderbegin">
                            <div>
                                <p>寄件人</p>
                                <p>工作时段&nbsp;&nbsp;<span>8:00-20:00</span></p>
                            </div>
                            <p>
                                <%= orderInfo.data.addressStart.realname%>&nbsp;&nbsp;<%= orderInfo.data.addressStart.mobile%></p>
                            <p><%= orderInfo.data.addressStart.address%></p>
                            <hr>
                        </div>
                        <div class="orderend">
                            <div>
                                <p>收件人</p>
                                <p>工作时段&nbsp;&nbsp;<span>10:00-22:00</span></p>
                            </div>
                            <p><%= orderInfo.data.addressEnd.realname%>&nbsp;&nbsp;<%= orderInfo.data.addressEnd.mobile%></p>
                            <p><%= orderInfo.data.addressEnd.address%></p>
                        </div>
                    </div>
                    <div class="other">
                        <p>其他需求：</p>
                        <div>
                            <%
                                getYMDHM = function(timeStamp) {
                                    var timeObj = new Date(parseInt(timeStamp));
                                    var year = timeObj.getFullYear();
                                    var month = timeObj.getMonth();
                                    var day = timeObj.getDate();
                                    var hour = timeObj.getHours();
                                    var min = timeObj.getMinutes();
                                    return year+"年"+month+"月"+day+"日"+hour+":"+min;
                                }
                            %>
                            <p>
                                <% if(orderInfo.data.isloading == "1") { %>
                                需要装卸工
                                <% } else { %>
                                不需要装卸工
                                <% } %>
                            </p>
                            <p>
                                <% if(orderInfo.data.lastArriveTime) { %>
                                <%= getYMDHM(orderInfo.data.lastArriveTime) %>前完成任务
                                <% } %>
                            </p>
                        </div>
                    </div>
                </div>
                <% } %>
            </div>

            <div data-tab-panel-1 class="am-tab-panel carrier">
                <% if(carDetail.data){%>
                <% carDetail.data.forEach(function(cars){%>
                <div class="box">
                    <div class="detail">
                        <div>
                            <p>驾驶员：</p>
                            <p><%= cars.username%><span>（DPI：60）</span></p>
                        </div>
                        <div>
                            <p>星级：</p>
                            <p>
                                <%
                                    getStar = function (star) {
                                        var star = parseInt(star);
                                        var starString = "";
                                        var starImg = '<img src="../views/images/task/single-star.png">';
                                        for (var i = 0; i < star; i++) {
                                            starString += starImg;
                                        }
                                        return starString;
                                    }
                                %>
                                <%- getStar(cars.stars)%>
                            </p>
                        </div>
                        <div>
                            <p>车牌：</p>
                            <p><%= cars.carCode%></p>
                        </div>
                        <div>
                            <p>车辆类型：</p>
                            <p><%= cars.carRemark%></p>
                        </div>
                    </div>

                        <div class="carphoto">
                            <p>车辆照片：</p>
                            <% if(carImgArray && carImgArray!=""){ %>
                            <div class="carslider">
                                <div data-am-widget="slider" class="am-slider am-slider-b3" data-am-slider='{&quot;animation&quot;:&quot;slide&quot;,&quot;animationLoop&quot;:false,&quot;itemWidth&quot;:100,&quot;itemMargin&quot;:5}' >
                                    <ul class="am-slides">
                                        <% var carImgArray = cars.carImg.split(","); %>
                                        <% carImgArray.forEach(function(carImg){ %>
                                        <li>
                                            <img src="<%= carImg%>">
                                        </li>
                                        <% })%>
                                    </ul>
                                </div>
                            </div>
                            <% }else { %>
                                <p style="color: #646464;padding-left: 7.5rem;">无</p>
                            <% } %>

                            <div class="finish">
                                <% if(parseInt(cars.status) == 9){ %>
                                    <button type="button" data-user="<%= cars.userSid %>" class="am-btn am-btn-success am-round" data-am-modal="{target: '#my-alert'}"  onclick="editThisText(this)">我要评价</button>
                                <% }else {%>
                                    <button type="button" class="am-btn am-btn-success am-round" style="background: #ccc;border: solid 1px #ccc;">我要评价</button>
                                <% } %>
                                <button type="button" class="am-btn am-btn-success am-round"> 电话投诉</button>
                            </div>
                        </div>
                </div>
                <%})%>
            <% }%>

            </div>
            <div data-tab-panel-2 class="am-tab-panel triptrack">
                <% if(orderRecord.data.length>0){%>

                <div class="box intransit">
                    <div class="con">
                        <p>订单追踪</p>
                        <div class="conlist">
                            <%
                                getMDHM = function(timeStamp) {
                                    var timeObj = new Date(parseInt(timeStamp));
                                    var month = timeObj.getMonth();
                                    var day = timeObj.getDate();
                                    var hour = timeObj.getHours();
                                    var min = timeObj.getMinutes();
                                    return month+"月"+day+"日\0\0"+hour+":"+min;
                                }
                            %>
                            <ul>

                                <li><span><%= getMDHM(orderRecord.data[orderRecord.data.length - 1].createdDt)%></span></li>
                                <li><%= orderRecord.data[orderRecord.data.length - 1].content%> <span class="livedetail" onclick="javascript:location.href='/order/liveDetails'">实时位置</span></li>
                            </ul>
                            <% for(var i=0;i<orderRecord.data.length-1;i++){%>
                            <ul>
                                <li><%= getMDHM(orderRecord.data[orderRecord.data.length-2-i].createdDt)%></li>
                                <li><%= orderRecord.data[orderRecord.data.length-2 -i].content%></li>
                            </ul>
                            <% }%>
                        </div>
                    </div>
                </div>
                <% } %>
            </div>

        </div>
    </div>
</div>

<div class="am-modal am-modal-alert" tabindex="-1" id="my-alert">
    <div class="am-modal-dialog">
        <div class="am-modal-hd con">
            <p>星级：</p>
            <form class="star-form">
                <fieldset class="starability-basic">
                    <input type="radio" id="rate5-1" name="rating" value="5" />
                    <label for="rate5-1" title="Amazing">5 stars</label>

                    <input type="radio" id="rate4-1" name="rating" value="4" />
                    <label for="rate4-1" title="Very good">4 stars</label>

                    <input type="radio" id="rate3-1" name="rating" value="3" />
                    <label for="rate3-1" title="Average">3 stars</label>

                    <input type="radio" id="rate2-1" name="rating" value="2" />
                    <label for="rate2-1" title="Not good">2 stars</label>

                    <input type="radio" id="rate1-1" name="rating" value="1" />
                    <label for="rate1-1" title="Terrible">1 star</label>
                </fieldset>
            </form>
        </div>
        <div class="am-modal-hd con">
            <p>时效性：</p>
            <form class="efficiency-form">
                <fieldset class="starability-basic">
                    <input type="radio" id="star5-1" name="rating" value="5" />
                    <label for="star5-1" title="Amazing">5 stars</label>

                    <input type="radio" id="star4-1" name="rating" value="4" />
                    <label for="star4-1" title="Very good">4 stars</label>

                    <input type="radio" id="star3-1" name="rating" value="3" />
                    <label for="star3-1" title="Average">3 stars</label>

                    <input type="radio" id="star2-1" name="rating" value="2" />
                    <label for="star2-1" title="Not good">2 stars</label>

                    <input type="radio" id="star1-1" name="rating" value="1" />
                    <label for="star1-1" title="Terrible">1 star</label>
                </fieldset>
            </form>
        </div>
        <hr>
        <div class="conde" id="conde">
            <p><span>神准时</span></p>
            <p><span>服务态度好</span></p>
            <p><span>态度差</span></p>
            <p><span>温柔大叔</span></p>
            <p><span>甘当搬运工</span></p>
            <p><span>百年好司机</span></p>
        </div>
        <div class="am-modal-footer">
            <button type="button" class="am-btn  am-modal-btn am-btn-success am-round" onclick="submitMyPingJia()"> 提交</button>
        </div>
    </div>
</div>
<script src="../commonjs/jquery-2.1.0.js"></script>
<script src="../commonjs/amazeui.min.js"></script>
<script type="text/javascript">
    $('#conde p').click(function(){
        if($(this).hasClass('active')){
            $(this).removeClass('active');
        }else{
            $(this).addClass('active');
        }
    });

    var $btnEdit;
    function editThisText(obj){
        $btnEdit = $(obj);
    }

    function submitMyPingJia(){
        $btnEdit.text("已评价");
        //获取星级
        var star = (10 - $(".star-form input:checked").index())/2;
        //获取时效性评价
        var efficiency = (10 - $(".efficiency-form input:checked").index())/2;
        //获取评价的标签
        var tagContent = [];
        $("#conde p.active").each(function () {
            tagContent += (($(this).text()) + ',');
        });
        //获取司机useSid
        var userId = $btnEdit.data("user");
        //获取订单编号
        var orderSid = $("header .order-num span").text();
        var param = {
            "stars":star,
            "timeness":efficiency,
            "labelName":tagContent,
            "userId":userId,
            "orderSid":orderSid
        };

        //发送ajax，提交评价的详情
        $.post("/task/assessDriver",param,function (data) {
            //获取星级评价
            console.log(data);

        })
    }
</script>
</body>
</html>