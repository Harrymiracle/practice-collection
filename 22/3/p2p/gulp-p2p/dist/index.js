"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(o){var n=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(o);return _possibleConstructorReturn(this,n?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var path=require("path"),fs=require("fs"),net=require("net"),_require=require("events"),EventEmitter=_require.EventEmitter,FileStatus={remoteCanceled:"remoteCanceled",canceled:"canceled",downloading:"downloading",downloadOk:"downloadOk",downloadFailed:"downloadFailed",uploading:"uploading",uploadOk:"uploadOk",uploadFailed:"uploadFailed",fileNotExist:"fileNotExist"},DADA_PACKAGE_SIZE=1048576;function packageP2PMsg(e){var t=e.cmd,t=void 0===t?2e3:t,o=e.token,n=e.fReadPath,r=e.offset,r=void 0===r?0:r,e=e.length,i=Buffer.alloc(780);return i.writeInt32LE(t,0),i.write(o,4),i.write(n,132),i.writeInt32LE(r,772),i.writeInt32LE(e,776),i}function parseP2PMsg(e){var t,o;if(780==e.length)return t=Math.min(e.indexOf(0,4),128),o=Math.min(e.indexOf(0,132),640),{cmd:e.readInt32LE(0),token:e.toString("utf8",4,t),fReadPath:e.toString("utf8",132,o),offset:e.readInt32LE(772),length:e.readInt32LE(776)}}function getUniquePath(e){var t,o=e,n=1,r=e;for(fs.existsSync(o)&&(t=path.extname(o),r=path.dirname(o)+path.sep+path.basename(o,t));fs.existsSync(o);)o=(o=r)+"(".concat(n,")")+t,n++;return o}function ntoa(e){return(e=e<0?2*(e>>>1)+(1&e):e)<0||4294967296<e?(console.error("Bad ntoa call with '"+e+"'."),!1):Math.floor(e%256)+"."+Math.floor(e/256%256)+"."+Math.floor(e/256/256%256)+"."+Math.floor(e/256/256/256)}var P2PPorts=[7270,7271,7272,7273,7274,7275,7276,7277,7278,7279,7280,7281,7282,7283,7284,7285,7286,7287,7288,7289],tcp_server=net.createServer(),portIndex=0,P2PPort=-1,init=Symbol("init"),startServer=Symbol("startServer"),dealConnect=Symbol("dealConnect"),uploadFile=Symbol("uploadFile");module.exports=function(){_inherits(t,EventEmitter);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.call(this)}return _createClass(t,[{key:init,value:function(){var t=this;tcp_server.on("connection",function(e){console.log("tcp_server connection",e.address()),t[dealConnect](e)}),tcp_server.on("error",function(e){console.log("tcp_server error!",e),"EADDRINUSE"===e.code&&(console.log("地址正被使用, 重试中..."),tcp_server.close(),++portIndex>=P2PPorts.length?console.error("端口全部监听失败"):t[startServer](P2PPorts[portIndex]))}),tcp_server.on("close",function(){console.log("tcp_server close!")})}},{key:startServer,value:function(e){return tcp_server.listen(e,"0.0.0.0",function(){P2PPort=e,console.log("tcp_server listening ",e)}),e}},{key:dealConnect,value:function(o){var n=this;o.on("data",function(e){var t=parseP2PMsg(e);console.log("received data %s msg: %s",e,t),t&&2e3===t.cmd?((t.socket=o).P2PMsg=t,n[uploadFile](t)):o.destroy()}),o.on("close",function(){console.log("client disconneted!"),n.emit("fileStatus",{token:token,fileStatus:FileStatus.remoteCanceled})}),o.on("error",function(e){console.log("client error disconneted!",e)})}},{key:uploadFile,value:function(e){e.cmd;var t,s,l,a,c,u=e.token,o=e.fReadPath,n=(e.offset,e.length,e.socket),f=this;this.emit("fileStatus",{token:u,fileStatus:FileStatus.uploading}),fs.existsSync(o)?(t=function e(t,o){var n,r,i;if(!c){for(;null!==(n=t.read(DADA_PACKAGE_SIZE));){console.log("读取文件 ".concat(n.length," 字节的数据"));break}o.destroyed?(console.log("网络断开或取消上传"),s.destroy(),o.destroyed||o.destroy()):(r=n)&&!(i=o.write(r,function(){console.log("send data length",r.length),a+=r.length,l<=a?(f.emit("progress",{token:u,progress:100}),f.emit("fileStatus",{token:u,fileStatus:FileStatus.uploadOk}),s.destroy()):(f.emit("progress",{token:u,progress:100*a/l}),e(t,o))}))&&(console.log("socket.write return ",i),c=!0)}},s=fs.createReadStream(o),l=fs.statSync(o).size,a=0,c=!1,n.on("drain",function(){console.log("drain"),c=!1}),s.on("readable",function(){if(n.destroyed)return console.log("网络断开或取消上传"),void s.destroy();console.log("readble"),t(s,n)}),s.on("end",function(){console.log("已没有数据"),s.destroy()})):(f.emit("fileStatus",{token:u,fileStatus:FileStatus.uploadFailed}),n.end())}},{key:"startP2PServer",value:function(){return this[init](),portIndex=0,this[startServer](P2PPorts[portIndex])}},{key:"getPort",value:function(){return P2PPort}},{key:"P2PDownload",value:function(e,t,o,n,r,i){var s=this,l=(this.emit("fileStatus",{token:o,fileStatus:FileStatus.downloading}),{host:e,port:t}),a=(i=getUniquePath(i),net.Socket(l)),c=fs.createWriteStream(i),u=0;c.on("close",function(){console.log("recv file close");var e=fs.statSync(i).size;r===u&&e===u?s.emit("fileStatus",{token:o,fileStatus:FileStatus.downloadOk}):s.emit("fileStatus",{token:o,fileStatus:FileStatus.downloadFailed})}),c.on("finish",function(){console.log("写入完成。")}),a.connect(l,function(){console.log("connected to Server",e,t),a.write(packageP2PMsg({token:o,fReadPath:n,length:r}))}),a.on("data",function(e){console.log("received data length:",e.length),fs.existsSync(i)?(u+=e.length,s.emit("progress",{token:o,progress:100*u/r}),c.write(e),r===u&&c.end()):(s.emit("fileStatus",{token:o,fileStatus:FileStatus.fileNotExist}),c.destroy(),a.destroy())}),a.on("end",function(){console.log("data end!"),fs.existsSync(i)&&(r===u?s.emit("fileStatus",{token:o,fileStatus:FileStatus.downloadOk}):s.emit("fileStatus",{token:o,fileStatus:FileStatus.remoteCanceled}))}),a.on("error",function(e){console.log("tcp_client error!",e),c.end()})}}]),t}();